# 第一章 总述
体系架构图 
![](../jpg/img_11.png)
- 数据采集层
  - web端日志采集计数：Aplus.JS;app端日志采集：UserTrack;
  - 面向各个场景埋点，满足通用浏览，点击，特殊交互，APP实践，H5和app里H5和Native日志数据打通的业务场景
  - 使用TimeTunnel：数据库的增量数据传输，包括日志数据的传输
  - 数据同步工具DataX
- 数据计算曾
  - 离线计算平台
  - 实时计算平台
  - 数据整合和管理体现
  - 数据加工链路
    - 操作数据层ODS，明细数据层DWD，汇总数据层DWS，应用数据层ADS
- 数据服务层
  - 以数据仓库整合计算好的数据作为数据源，对外通过接口的方式提供数据服务：数据查询，复杂数据查询（用户识别，用户画像），实时数据推送
- 数据应用层

# 第一篇
## 第二章 日志采集
- 浏览器的页面日志采集
  - 页面浏览/展现日志采集
    - PV页面浏览量，UV访客数
    - ![](../jpg/img_12.png)
    - 客户端日志采集：由植入页面HTML文档的jsp脚本执行，可以在业务服务器响应业务请求时动态执行；也可以开发页面时，由开发人员手动植入
    - 客户端日志发送：将采集到的数据发送到日志服务器
    - 服务端日志收集：写入日志缓冲区
    - 服务端日志解析存档：日志处理程序顺序读出并按照约定的日志处理逻辑解析
  - 页面交互日志采集
    - 高度自定义的业务特征
    - 用技术服务的形式
      - 注册需要采集交互日志的业务，具体的业务场景以及场景下的具体交互采集点
      - 植入目标也买你
      - 采集代码与因为u互动响应代码一起被触发和执行
      - 发送日志
  - 页面日志的服务器端清洗和预处理
    - 识别流量攻击，网络爬虫和流量作弊
    - 数据去向补正：如身份信息回补
    - 无效数据剔除
    - 日志隔离分发
- 无线客户端的日志采集
  - 目的：分析设备分析，了解用户信息，行为
  - 工具：名为UserTrack的SDK
    - 事件：日志行为的最小单位
  - 页面事件（页面浏览行为）
    - 设备和用户的基本信息
    - 被访问页面的信息
    - 访问基本路径
    - UT的手动模式埋点
      - 提供两个接口，分别在页面展现和页面退出的时候调用
      - 页面扩展信息的接口
      - UT可以实现页面事件的无痕埋点：即无需开发者任何编码即可实现
    - 离开时发送日志：准确知道页面的停留时长
    - 透传参数：当前页面的信息，传递到下一个页面的日志中
      - 使用SPM（超级位置模型）来追踪来源去向，可以稀松还原用户行为路径
  - 控件点击和其他事件
    - 高度自定义的业务特征
    - 记录基本的设备信息，用户信息；+ 控件所在页面名称，控件名称，控件的业务参数。只需要把相关基础信息告诉采集SDK
    - 其他事件：根据业务，自定义事件来采集相关信息
    - 自动捕获应用崩溃，与业务信息不是非常相关的时候，不用开发者触发埋点
  - 特殊场景
    - 每个曝光的元素一般属于一个页面，利用页面的生命周期来实现实弹的聚合及确定发送时机
    - 平衡日志大小，减小流量消耗，采集服务器压力，网络传输压力等
    - 回退行为的识别
  - H5和Native日志统一
    - 既有Native和H5页面，Hybrid app
    - 互跳导致：数据丢失严重，多端的数据隔离，多样的数据口径整理分析和解释
    - 方案：两种日志归一，阿里选择Native部署采集SDK
      - 可以采集更多设备相关数据
      - 待机SDK处理日志，可以先本地缓存然后借机上传。将H5日志归到Native日志
      - 浏览器采集jsp,WebView框架提供接口,客户端采集SDK
  - 设备标识
    - 设备厂商和用户逐渐加强隐私意识，设备唯一标识很难获得，但对多APP的公司来说很重要
  - 日志传输
    - 上传：先存储在客户端本地，然后伺机上传，考虑日志的大小和合理性
    - 存储：切分维度为天，对日志进行分流
- 挑战
  - 实现日志数据的结构化和规范化组织；实现更为高效的下游统计计算
  - 场景
    - 日志分流，定制处理：通过尽可能靠前地布置路由差异，就可以尽可能早地进行分流，降低日志处理过程中 的分支判断消耗
    - 采集与计算一体化设计：两套日志规范和与之对应的元数据中 。
  - 大促保障
    - 全链路保障
    ![](../jpg/img_13.png)

## 第三章 数据同步
- 数据同步基础
  - 直连同步
    - 定义：定义好的接口API和基于动态链接库的方式直接连接业务库，如ODBC/JDBC
    - 特点：配置简单，实现容易，适合操作性业务系统的数据同步
    - 性能影响大，大批量数据同步会严重影响性能。主备策略时，可以从备库抽取数据
  - 数据文件同步
    - 由专门的文件服务器，如FTP服务器传输到目标系统，加载到目标数据库系统中
    - 适合多个异构的数据库系统，日志类数据
    - 校验文件，防止丢包，错误
  - 数据库日志解析同步
    - 解析日志文件获取发生变更的数据
    - 读取日志文件，收集数据信息，数据文件传输到目标系统，加载数据
    - 问题：数据延迟，投入较大，数据漂移和遗漏
- 阿里的数据仓同步方式
  - 特点：
    - 数据来源的多样性
    - 数据量很大，阿里达到EB级别
  - 批量数据同步
    - 将各类数据库系统的数据类型同一转换位字符串类型的方式，实现数据格式的统一
    - DataX:分布式模式，3小时完成2PB
      - Framework 处理缓冲、流程控制、并发、上下文加载等高速数据交换的大部分技术问题，提供简单的接口与插件接人
      - 插件仅需实现对数据处理系统的访问，编写方便
  - 实时数据同步
    - 解析 MySQL binlog日志来实时获得增量的数据更新，并通过消息订阅模式来实现数据的实时同步的
    - TimeTunnel:基于生产者、消费者和 Topic 消息标识的消息中间件，将消息数据持久化到 HBase 的高可用、分布式数据交互系统。
- 遇到的问题和解决方案
  - 分库分表
    - 分布式表：通过建立中间状态的逻辑表来统一分库分表的访问
    - 持久层框架之下、 DB 驱动之上的中间件
  - 高效同步和批量同步
    - OneClick
      - 自动获得元数据信息和配置信息
      - 建表，配置任务，发布，测试操作一键化处理，封装程web接口
  - 增量和全量同步的合并
    - 全量改同步新变更的增量数据
    - 使用merge方式，但大数据平台一般不支持update操作
    - 全外连接+数据全量覆盖重新加载。数据更新错误问题：分区方式
  - 同步性能的处理
    - 负载均衡：通过目标数据库的元数据估算同步任务的总线程数
  - 数据飘逸的处理
    - 更新时间，日志更新时间，业务发生时间，处理数据时间
    - 方法：
      - 多取后一天数据
      - 多个字段限制时间获取准确数据
        - 根据log_time冗余后一天15min的数据，用modified_time 过滤非当天数据，然后用全外连接回补数据

## 第四章 离线数据开发
- 数据开发平台
  - 统一计算平台MaxCompute
    - 体系架构
    ![](../jpg/img_14.png)
    - 特点
      - 计算性能高，集群规模大，稳定性高，功能组件强大，安全性高
  - 统一开发平台
    - 在云端D2：任务开发、调试及发布，生产任务调度及大数据运维数据权限申请及管理
    - SQLscan:代码检查，SQL检查
    - DQC：数据质量中心：数据监控，数据清洗
    - 在彼岸：功能测试：新增业务需求，数据迁移，重构和修改
      - 组件：数据对比，数据分布，数据脱敏：模糊化
  - 任务调度系统
    - 背景：任务互相依赖，传统的crontab基于时间不能满足
    - 介绍：
      - 开发后，同通过调度系统按顺序执行
      - 核心模块：调度引擎，执行引擎
      - 任务状态机模型
      - 工作流状态机模型
      - 调度引擎工作原理
        - 以事件驱动的方式运行，为数据任务节点生成实例，并在调度树中生成具体执行的工作流
      - 执行引擎工作原理：资源调配，上下文环境
      - 执行引擎用法
    - 特点和应用
      - 调度配置
      - 定时调度
      - 周期调度
      - 手动执行
      - 补数据
      - 基线管理
      - 监控报警

## 第五章 实时计数
- 简介
  - 流式实时处理技术
  - 时效性：离线，准实时，实时
  - 时效性高，常驻任务，性能要求高，应用局限性
- 流式技术架构
  - 数据采集-数据处理-数据存储-数据服务
  ![](../jpg/img_15.png)
  - 数据采集
    - 数据种类：数据库变更日志，引擎访问日志
    - 采集原则：数据大小限制，时间阈值限制
    - 数据中间件：kafka,TimeTunnel
    - 消息系统，延时毫秒级别，但吞吐量低
  - 数据处理
    - 常用：storm，spark streaming，flink
    - 用Stream SQL
    - 典型问题
      - 去重指标
        - 精确去重，数据倾斜，保存明细数据，将一个节点的内存压力分发到多个节点
        - 模糊去重：
        - 布隆过滤器：位数组算法，不保存真实的明细数据，保存明细数据对应的哈希值标记位，误差率可控，使用精度不高，维度值很多
        - 基数统计：利用哈希：按照数据的分散程度估算现有数集的边界；精度要求不高，统计维度粒度很粗，如天粒度
  - 数据倾斜
    - 去重指标分桶：对去重值进行分桶HASH
    - 非去重指标分桶:数据随机分发，汇总
  - 事务处理
    - 原因：系统的不稳定性，导致数据处理失败，如网络抖动，机器重启，数据丢失
    - 超时时间
    - 事务信息
    - 备份机制
    - 保证数据的幂等性
  - 数据存储
    - 中间计算结果
    - 最终的结果数据
    - 维表数据
    - 数据库：支持多并发读写，满足实时的性能要求，一般使用HBase等列式存储系统
    - 经验：
      - 表名设计：汇总层标识＋数据域＋主维度＋时间维度；如：dws_trd_slr_dtr
      - rowkey设计：MD5 ＋主维度＋维度标识＋子维度 ＋时间维度＋子维度2
  - 数据服务
    - 如OneService
    - 不直连数据库
    - 屏蔽底层取数逻辑
    - 屏蔽存储系统差异
- 流式数据模型
  - 数据分层
    - ODS：操作数据层，聪业务系统采集的原始数据
    - DWD：根据业务过程建模出来的实时事实明细层
    - DWS：计算各个维度的汇总指标
    - ADS：个性化维度汇总层，不通用的
    - DIM:离线维表层中导出的
    ![](../jpg/img_16.png)
    - 更具重要性优先级，分配计算和存储资源
  - 多流关联
    - 两个实时流关联，问题，数据的到达是增量过程，到达时间是不确定和无序的，涉及中间状态的保存和恢复机制
    - 相互等待，直到关联成功
    - 备份到外部存储系统，任务重启是，可以恢复内存数据
  - 维表使用：使用当前的实时数据（ ）去关联 T-2 的维表数据
    - 数据无法及时准备好
    - 无法准确获取全量最新的数据
    - 数据的无序性
    - 维表的使用方式
      - 全量加载
      - 增量加载：LRU过期
- 大促挑战&保障
  - 特征
    - 毫秒级延时
    - 洪峰明显
    - 高保障性
    - 公关特性
  - 大促保障
    - 实时任务优化
      - 独占资源和共享资源的策略
      - 合理选择缓存机制，尽量降低读写库次数
      - 计算单元合并，降低拓扑层级
      - 内存对象共享，避免字符拷贝
      - 在高吞吐量和低延时间取平衡
    - 如何进行数据链路保障
      - 多链路搭建，多机房容灾，甚至异地容灾
      - 比对多链路计算的结果数据，一键切换到备链路
    - 如何进行压测
      - 数据压测：蓄洪压测
      - 产品压测：产品本身压测，前端页面稳定性测试

## 第六章 数据服务
- 服务架构演进
  - DWSOA: 需求驱动：一个需求开发一个或者几个接口，通过SOA的方式暴露 
  - Open API: 将数据按照统计粒度进行聚合，同样维度的数据，形成一张逻辑表
  - SmartDQ:使用标准SQL语法，使用ORM对象关系映射框架封装标准dataSource.使用逻辑表层，只用变更物理字段的映射，即可完成字段变更
  - 统一的数据服务层：OneService
    - Lego:插件化开发，Docker隔离
    - WebSocker和 long polling:实时数据服务IPUSH
    - uTiming：即时任务和定时任务
- 技术架构
  - SmartDQ
    - 元数据模型：逻辑表到物理表的映射
      - 数据源，物理表，逻辑表，主题
    - 架构图
      ![](../jpg/img_17.png)
      - 查询数据库实时公共层的九三作业，同步作业公共层的离线数据
      - 服务层:
        - 元数据配置：物理表和逻辑表的映射关系
        - 主处理模块：一次查询聪开始到返回，DSL解析，逻辑Query构建，物理Query构建，Query拆分，SQL执行，结果合并
        - 其他模块
  - iPush
    - 消息源：TT,MetaQ
    - 定制过滤规则，向消息中间件推送
    - 基于高性能异步事件驱动模型的网络通信框架Netty 4
  - Lego
    - 中高度定制化数据查询需求，支持差劲啊
    - 提供日志，服务注册，Diamond配置监听，鉴权，数据源管理
  - uTiming
    - 云端的任务调用，批量数据处理服务，支持用户识别，用户画像，人群圈选服务的离线计算
    - 调度执行 SQL 或特定配置的离线任务
- 最佳实践
  - 性能
    - 资源分配
      - 剥离计算资源，由底层的数据公共层计算
      - 查询资源分配：get线程池，和list线程池
      - 执行计划优化：查询拆分，查询优化list转换为get
    - 缓存优化
      - 元数据缓存：减少元数据调用的性能算好
      - 模型缓存：将解析后的模型缓存（逻辑模型，物理模型）
      - 结果缓存：
    - 查询能力
      - 合并查询：实时+离线，优先用离线，replace语法
      - 推送服务：避免轮询导致资源浪费，有新数据自动通知
  - 稳定性
    - 发布系统
      - 元数据隔离：日常，预发，线上环境
      - 隔离发布：资源划分，资源独占，增量更新
    - 隔离
      - 机房隔离 
      - 分组隔离
    - 安全限制
      - 最大返回记录数，必传字段，超时实践
    - 监控
      - 调用日志采集
      - 调用监控
    - 限流，降级
      - 限流“QPS保护
      - 降级：限流防止故障扩散，修改元数据让访问失败

## 第七章 数据挖掘
